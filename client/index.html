<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Artists - YTMusic</title>

    {{meta}}{{tabler}}
  </head>
  <body>
    {{navbar}}

    <div class="page-body container-fluid text-center">
      <h1>Artists</h1>
      <div class="input-icon mt-3 mb-2">
        <span class="input-icon-addon ti ti-search"></span>
        <input type="text" class="form-control" placeholder="Search by Name" id="name-input" />
      </div>
      <div id="artists" class="row row-cards" data-masonry='{"percentPosition": true }'></div>
    </div>

    <script>
      let artists = document.getElementById("artists");
      function filterName(name) {
        let allowed = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890-_()!@#%& .,";
        let newName = "";
        name.split("").forEach((n) => {
          if (allowed.includes(n)) newName += n;
        });
        return newName;
      }

      function openArtist(a) {
        let old = document.getElementById("artist-modal");
        if (old) old.remove();

        let modal = document.createElement("span");
        modal.id = "artist-modal";
        modal.innerHTML = `{{artist-open}}`;
        let styles = {
          position: "absolute",
          width: "100%",
          height: "100%",
          top: `${document.body.parentElement.scrollTop}px`,
          left: "0px",
          backgroundColor: "rgba(0,0,0,0.5)",
        };
        Object.keys(styles).forEach((s) => {
          modal.style[s] = styles[s];
        });
        let color = Theme.current == "light" ? "000000" : "ffffff";
        let btn = modal.querySelector(".btn-close");
        btn.style.background = `transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23${color}'%3e%3cpath d='M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z'/%3e%3c/svg%3e") center/.75rem auto no-repeat`;
        btn.onclick = function () {
          modal.remove();
          document.body.style.overflow = "";
        };
        document.body.style.overflow = "hidden";
        document.body.appendChild(modal);

        let limit = 15;

        let currentPage = 0;
        let pages = [];
        let current = 0;

        function buildPages() {
          pages = [];
          currentPage = 0;
          current = 0;

          a.albums
            .sort((a_, b) => {
              return filterName(a_.name.toLowerCase().replace(/the /i, "")) >
                filterName(b.name.toLowerCase().replace(/the /i, ""))
                ? 1
                : -1;
            })
            .forEach((al, i) => {
              a.albums[i].songs = al.songs.sort((a_, b) => {
                return filterName(a_.name.toLowerCase().replace(/the /i, "")) >
                  filterName(b.name.toLowerCase().replace(/the /i, ""))
                  ? 1
                  : -1;
              });
            });

          a.albums.forEach((al) => {
            al.songs.forEach((song) => {
              pages[currentPage] = pages[currentPage] || [];
              pages[currentPage].push({ a: al, song });
              current++;
              if (current % limit == 0) currentPage++;
            });
          });
        }
        buildPages();

        let loadedPage = 1;
        function loadPage(num) {
          loadedPage = num;
          let asd = document.getElementById("artist-songs-data");
          asd.innerHTML = "";
          let page = pages[num - 1];
          page.forEach((d) => {
            let a = d.a,
              song = d.song;
            let s = document.createElement("tr");
            s.innerHTML = `{{artist-songs-data}}`;
            asd.appendChild(s);
          });
          document.getElementById("showing-min").innerHTML = (
            num * limit - limit || 1
          ).toLocaleString();
          document.getElementById("showing-max").innerHTML = Math.min(
            num * limit,
            current - 1
          ).toLocaleString();
          document.getElementById("showing-all").innerHTML = (current - 1).toLocaleString();

          let minPage = num - 2;
          if (minPage < 1) minPage = 1;
          if (minPage + 3 > pages.length) minPage -= 2;
          if (minPage + 4 > pages.length) minPage--;

          [1, 2, 3, 4, 5].forEach((sw) => {
            let swe = document.getElementById(`switcher-${sw}`);
            let pageNum = minPage + sw - 1;
            swe.firstElementChild.innerHTML = pageNum;
            if (num == pageNum) swe.classList.add("active");
            else swe.classList.remove("active");
            swe.onclick = function () {
              swe.firstElementChild.blur();
              loadPage(pageNum);
            };
          });

          let back = document.getElementById("switcher-back");
          if (num <= 1) back.classList.add("disabled");
          else back.classList.remove("disabled");
          back.onclick = function () {
            back.firstElementChild.blur();
            if (back.classList.contains("disabled")) return;
            loadPage(num - 1 || 1);
          };

          let next = document.getElementById("switcher-next");
          if (num >= pages.length) next.classList.add("disabled");
          else next.classList.remove("disabled");
          next.onclick = function () {
            next.firstElementChild.blur();
            if (next.classList.contains("disabled")) return;
            loadPage(num + 1);
          };
        }
        loadPage(loadedPage);
      }

      fetch(`/api/artists/all`)
        .then((res) => res.json())
        .then(async (res) => {
          if (res.err) return;

          let artists = document.getElementById("artists");
          artists.innerHTML = "";

          res
            .sort((a, b) => {
              return filterName(a.name.toLowerCase().replace(/the /i, "")) >
                filterName(b.name.toLowerCase().replace(/the /i, ""))
                ? 1
                : -1;
            })
            .forEach((a) => {
              let artist = document.createElement("div");
              artist.innerHTML = `{{artist-card}}`;
              artist.classList.add("col-sm-6", "col-lg-4");
              artist.onclick = function () {
                openArtist(a);
              };
              artists.appendChild(artist);
              let hover = document.getElementById(`card-overlay-${a.id}`).querySelector("span");
              hover.className = "ti ti-settings text-indigo";
              hover.style.textShadow = "none";
            });
        })
        .catch((err) => {
          console.log("Server is down? Error: " + err);
        });
    </script>
  </body>
</html>
